<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monty Web-Bluetooth Terminal</title>
    <style>
        /* GitHub Color Palette */
        :root {
            --gh-bg: #f6f8fa;
            --gh-header-bg: #24292e;
            --gh-text: #24292e;
            --gh-text-secondary: #586069;
            --gh-border: #e1e4e8;
            --gh-button-border: rgba(27, 31, 35, 0.15);
            --gh-blue: #0366d6;
            --gh-green: #2ea44f;
            --gh-red: #d73a49;
        }
        
        /* Base styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            padding: 0;
            background-color: var(--gh-bg);
            color: var(--gh-text);
            line-height: 1.5;
        }
        .header {
            text-align: center;
            padding: 16px 20px;
            background-color: var(--gh-header-bg);
            color: white;
            border-bottom: 1px solid #1b1f23;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 32px;
            padding: 0 24px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1012px;
            margin-bottom: 24px;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--gh-button-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s cubic-bezier(0.3, 0, 0.5, 1);
            font-family: inherit;
            flex-grow: 1;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 1px 0 rgba(27, 31, 35, 0.04);
        }
        
        /* Button Variants */
        #btn-connect { 
            background-color: #f6f8fa;
            color: var(--gh-text);
        }
        #btn-connect:hover { background-color: #f3f4f6; }
        
        #btn-getall {
            background-color: var(--gh-blue);
            color: white;
            border-color: rgba(27, 31, 35, 0.15);
        }
        #btn-getall:hover { background-color: #0361cd; }

        #btn-save {
            background-color: var(--gh-green);
            color: white;
            border-color: rgba(27, 31, 35, 0.15);
        }
        #btn-save:hover { background-color: #2c974b; }
        
        #btn-disconnect {
            background-color: var(--gh-red);
            color: white;
            border-color: rgba(27, 31, 35, 0.15);
        }
        #btn-disconnect:hover { background-color: #cb2431; }

        .terminal {
            width: 100%;
            max-width: 1012px;
            height: 440px;
            margin-bottom: 16px;
            padding: 16px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            resize: vertical;
            font-size: 13px;
            border: 1px solid var(--gh-border);
            border-radius: 6px;
            background-color: #ffffff;
            box-shadow: inset 0 1px 0 rgba(27,31,35,.075);
        }
        .status-panel {
            width: 100%;
            max-width: 1012px;
            background-color: #fff;
            border: 1px solid var(--gh-border);
            border-left-width: 5px;
            padding: 16px;
            border-radius: 6px;
            text-align: left;
            margin-bottom: 32px;
        }
        .status-panel.error { border-left-color: var(--gh-red); }
        .status-panel.connected { border-left-color: var(--gh-green); }
    </style>
</head>

<body>
    <div class="header">
        <h1>Monty BLE Terminal</h1>
    </div>

    <div class="container">
        <div class="controls">
            <button class="btn" id="btn-connect" onclick="connect()">Connect üîå</button>
            <button class="btn" id="btn-disconnect" onclick="disconnect()">Disconnect ‚ùå</button>
            <button class="btn" id="btn-getall" onclick="getAll()">Get All Records üöÄ</button>
            <button class="btn" id="btn-save" onclick="saveToCSV()">Save as CSV üíæ</button>
        </div>

        <textarea id="term" readonly class="terminal" placeholder="Connect to a device to see logs..."></textarea>
        
        <div id="statusPanel" class="status-panel">
            <strong>Status:</strong> <span id="statusMessage">Disconnected</span>
        </div>
    </div>

<script>
    // --- State Variables ---
    let notifyCharacteristic;
    let writeCharacteristic;
    let deviceName;
    let getAllButtonPressed = false;
    let isConnected = false;
    let mutipleRecordArray = [];
    let accumulateRecords = false;

    // --- UI Elements ---
    const term = document.getElementById("term");
    const statusMessage = document.getElementById("statusMessage");
    const statusPanel = document.getElementById("statusPanel");

    // --- Main Functions ---

    function connect() {
        if (isConnected) {
            log("! Already connected. Please disconnect first.");
            return;
        }
        const serviceUuid = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const notifyUuid = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // RX
        const writeUuid = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";  // TX

        log("Requesting Bluetooth device...");
        navigator.bluetooth.requestDevice({
            filters: [{ services: [serviceUuid] }],
        })
        .then(device => {
            log(`Connecting to ${device.name || 'device'}...`);
            deviceName = device.name;
            return device.gatt.connect();
        })
        .then(server => {
            log("Getting primary service...");
            return server.getPrimaryService(serviceUuid);
        })
        .then(service => {
            log("Getting characteristics...");
            return Promise.all([
                service.getCharacteristic(notifyUuid),
                service.getCharacteristic(writeUuid)
            ]);
        })
        .then(([notifyChar, writeChar]) => {
            notifyCharacteristic = notifyChar;
            writeCharacteristic = writeChar;
            log("Starting notifications...");
            return notifyCharacteristic.startNotifications();
        })
        .then(() => {
            log(`> Notifications started successfully.`);
            notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
            isConnected = true;
            updateStatus(`Successfully connected to: ${deviceName}`, false, true);
        })
        .catch(error => {
            log('! Error: ' + error);
            updateStatus(`Connection Error: ${error.message}`, true);
        });
    }

    function disconnect() {
        if (notifyCharacteristic && notifyCharacteristic.service.device.gatt.connected) {
            notifyCharacteristic.stopNotifications()
            .then(_ => {
                log('> Notifications stopped.');
                notifyCharacteristic.removeEventListener('characteristicvaluechanged', handleNotifications);
                return notifyCharacteristic.service.device.gatt.disconnect();
            })
            .then(() => {
                log("Device disconnected.");
                isConnected = false;
                updateStatus("Disconnected");
            })
            .catch(error => {
                log('! Disconnect Error: ' + error);
                updateStatus(`Disconnect Error: ${error.message}`, true);
            });
        } else {
            log("! Not connected.");
        }
    }

    function handleNotifications(event) {
        const value = event.target.value;
        const packet = new TextDecoder().decode(value);
        
        if (packet.trim()) {
            log('> ' + packet.trim());
        }

        if (accumulateRecords) {
            mutipleRecordArray.push(packet);
        }

        const [ret, args] = [packet.slice(0, 3), packet.slice(3)];
        if (ret === ";RA" && getAllButtonPressed) {
            getAllButtonPressed = false;
            mutipleRecordArray = [];
            accumulateRecords = true;

            const [startId, endId] = args.split(',').map(Number).slice(0, 2);
            log(`> Received record range: ${startId} to ${endId}. Fetching all records...`);
            queryMultiple(startId, endId);
        }
    }

    function sendQuery(query) {
        if (!writeCharacteristic) {
            log("! Cannot send query: Not connected.");
            return;
        }
        const command = `${query}\r\n`;
        return writeCharacteristic.writeValue(new TextEncoder().encode(command));
    }

    function queryMultiple(id, endId) {
        if (id > endId) {
            log("> Finished querying all records.");
            accumulateRecords = false;
            return;
        }
        setTimeout(() => {
            sendQuery(`;QM ${id},${id}`);
            queryMultiple(id + 1, endId);
        }, 100);
    }

    function getAll() {
        if (!isConnected) {
            log("! Please connect to a device first.");
            return;
        }
        log("----------------------------------------");
        log("Starting 'Get All' process... üöÄ");
        sendQuery(';QA');
        getAllButtonPressed = true;
    }

    function saveToCSV() {
        if (mutipleRecordArray.length === 0) {
            log("! No data to save. Use 'Get All Records' to fetch data first.");
            return;
        }

        const fullString = mutipleRecordArray.join('');
        const records = fullString.split('\r\n').filter(rec => rec.startsWith(';RM'));

        log(`> Preparing to save ${records.length} records...`);

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "timestamp,temperature_c,humidity_rh,tvoc_ppb,iaq_index\r\n";

        records.forEach(recordString => {
            try {
                const record = JSON.parse(recordString.slice(3));
                const row = [
                    record.time_s || '',
                    record.bme680_temp || '',
                    record.bme680_rh || '',
                    record.sgpc3_gas_etvoc || '',
                    record.bme680_gas_iaq || ''
                ].join(',');
                csvContent += row + "\r\n";
            } catch (err) {
                console.error("Failed to parse record:", recordString, err);
                log(`! Warning: Could not parse a record. Skipping. Raw: ${recordString}`);
            }
        });

        log("> CSV file ready. Triggering download...");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `monty_data_simplified_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function log(str) {
        term.value += str + "\n";
        term.scrollTop = term.scrollHeight;
    }

    function updateStatus(message, isError = false, isConnectedStatus = false) {
        statusMessage.textContent = message;
        statusPanel.className = 'status-panel'; // Reset class
        if (isError) {
            statusPanel.classList.add('error');
        } else if (isConnectedStatus) {
            statusPanel.classList.add('connected');
        }
    }
</script>

</body>
</html>